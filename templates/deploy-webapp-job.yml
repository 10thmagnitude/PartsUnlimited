parameters:
  environment: ''
  webAppRG: ''
  webApp: ''
  azureSub: ''
  runQuickPerfTests: 'no'
  vstsEndpoint: ''
  dependsOn: 'runTerraform'

jobs:
- deployment: deployWebApp
  dependsOn: ${{ parameters.dependsOn }}
  displayName: Deploy Web App
  pool:
    vmImage: 'windows-latest'
  variables:
    artifactName: drop
    package: '$(Pipeline.Workspace)/$(artifactName)/PartsUnlimitedWebsite.zip'
  environment:
    ${{ parameters.environment }}
  strategy:
    runOnce:
      deploy:
        steps:
        - download: current
          artifact: '$(artifactName)'

        - task: AzureRmWebAppDeployment@4
          displayName: 'Azure App Service Deploy: ${{ parameters.webApp }}'
          inputs:
            azureSubscription: '${{ parameters.azureSub }}'
            WebAppName: '${{ parameters.webApp }}'
            packageForLinux: '$(Package)'
        
        - task: AzurePowerShell@4
          displayName: 'Set sticky for SlotName appsetting'
          inputs:
            azureSubscription: '${{ parameters.azureSub }}'
            ScriptType: InlineScript
            Inline: |
              New-AzureRmResource -ResourceGroupName $WebApp -ResourceType Microsoft.Web/sites/Config -Name $WebApp/slotConfigNames -PropertyObject @{ appSettingNames = @("SlotName") } -ApiVersion 2015-08-01 -Force
            scriptArguments: '-WebApp ${{ parameters.webApp }}'
            azurePowerShellVersion: LatestVersion
        
        - ${{ if eq(parameters.runQuickPerfTests, 'yes') }}:
          - task: QuickPerfTest@1
            displayName: 'Quick Web Performance Test PartsUnlimited-$(System.StageName)'
            inputs:
              connectedServiceName: '${{ parameters.vstsEndpoint }}'
              websiteUrl: 'https://${{ parameters.webApp }}.azurewebsites.net'
              testName: 'PartsUnlimited-$(System.StageName)'
              avgResponseTimeThreshold: 300
            condition: succeeded()